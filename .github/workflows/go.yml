name: Go

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Build
      run: go build -v ./...

  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go + testing tools
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Staticcheck
      run: |
        go install honnef.co/go/tools/cmd/staticcheck@latest
        staticcheck ./...
      shell: bash

    - name: Gofumpt
      run: |
        go install mvdan.cc/gofumpt@latest
        output=$(gofumpt -l .)
        if [ ! -z "$output" ]; then echo "$output" && exit 1; fi
      shell: bash

    - name: Test 
      run: |
        if ! go test -v -race -cover ./... > /tmp/testResult; then
          echo /tmp/testResult
          exit 1
        fi
        go install github.com/baalimago/percentaverage@latest
        cat /tmp/testResult | percentaverage -r > ./global_test_coverage

    - name: Update testcoverage
      uses: actions/checkout@v3
    - name: Now github will be happy
      run: |
        perc=$(cat ./global_test_coverage)
        perc_rounded=${perc%%.*}
        if [ $perc_rounded -ge 80 ]; then
          rating="ğŸ˜ğŸ‘Œ"
        elif [ $perc_rounded -ge 50 ]; then
          rating="ğŸ˜ŒğŸ‘"
        elif [ $perc_rounded -ge 20 ]; then
          rating="ğŸ˜’ğŸ‘"
        else
          color="ğŸ˜ ğŸ‘"
        fi

        sed -i "s/Test coverage: .*/Test coverage: $perc% $rating/" README.md

        git add README.md
        # I'm not too sure about this one
        git config --global user.email "actions@github.com"
        git config --global user.name "Github Actions"
        git commit -m "GithubActions: Updated testcoverage"
        git push
      shell: bash

    
